<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Absen Karyawan</title>
<style>
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;margin:16px;background:#f7f8fb;color:#111}
  .card{background:white;padding:20px;border-radius:10px;max-width:400px;margin:auto;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
  h1{font-size:20px;margin-bottom:16px;text-align:center}
  select,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ccc}
  button{background:#1f6feb;color:white;border:0;cursor:pointer}
  button:hover{background:#1557b0}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse;background:white;border-radius:8px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
  th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #eef0f4}
  th{background:#f1f5f9;font-weight:600}
  tr:hover td{background:#fbfdff}
  @media (max-width:600px){th,td{padding:8px}}
  .small{font-size:13px;color:#50586a}
  #status{margin-top:8px;font-size:13px;color:#333}
</style>
</head>
<body>

<div id="loginScreen" class="card">
  <h1>Login Absen</h1>
  <label>Pilih Nama:</label>
  <select id="nameSelect"></select>
  <button id="loginBtn">Login</button>
</div>

<div id="absenScreen" style="display:none;">
  <header>
    <div>
      <h1>Absen Karyawan</h1>
      <div class="small">Login sebagai: <span id="userName"></span></div>
    </div>
    <div class="controls">
      <button id="btnLogout" class="secondary">Logout</button>
      <button id="btnReload">Reload</button>
    </div>
  </header>

  <div id="status">Memuat data...</div>
  <div style="margin-top:12px;overflow:auto">
    <table>
      <thead><tr id="theadRow"></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSyAD19vapWIxD6g1NlIy63tyH0stasOJtgSfVdTRrJfBkmsOYPfp5hIZ3qlyZqE-BJwhbT2Wjl3V5O/pub?gid=853862450&single=true&output=csv";

const loginScreen = document.getElementById('loginScreen');
const absenScreen = document.getElementById('absenScreen');
const nameSelect = document.getElementById('nameSelect');
const loginBtn = document.getElementById('loginBtn');
const btnLogout = document.getElementById('btnLogout');
const btnReload = document.getElementById('btnReload');
const userNameSpan = document.getElementById('userName');
const statusEl = document.getElementById('status');
const theadRow = document.getElementById('theadRow');
const tbody = document.getElementById('tbody');

let rawData = [];
let currentUser = "";

async function fetchCSV(){
  statusEl.textContent = "Mengambil data...";
  try {
    const res = await fetch(CSV_URL);
    const text = await res.text();
    parseCSV(text);
    statusEl.textContent = `Selesai. ${rawData.length} baris ditemukan.`;
  } catch(err) {
    statusEl.textContent = "Error: " + err.message;
    console.error(err);
  }
}

function parseCSV(csvText){
  const lines = csvText.split(/\r\n|\n/).filter(l=>l.trim()!=="");
  const header = parseCSVLine(lines[0]);
  const rows = [];
  for(let i=1;i<lines.length;i++){
    const vals = parseCSVLine(lines[i]);
    const obj = {};
    header.forEach((h,j)=> obj[h] = vals[j] || "");
    rows.push(obj);
  }
  rawData = rows;
  populateNameList(header);
  if(currentUser) renderTable(header, rows);
}

function parseCSVLine(line){
  const result = []; let cur = "", inQuotes = false;
  for(let ch of line){
    if(ch === '"'){ inQuotes = !inQuotes; }
    else if(ch === ',' && !inQuotes){ result.push(cur); cur=""; }
    else{ cur += ch; }
  }
  result.push(cur);
  return result;
}

function populateNameList(header){
  if(nameSelect.options.length > 0) return; // hanya isi sekali
  const nameCol = header.find(h=>/nama|name/i.test(h)) || header[0];
  const uniqueNames = [...new Set(rawData.map(r=>r[nameCol]).filter(n=>n))].sort();
  nameSelect.innerHTML = "";
  uniqueNames.forEach(n=>{
    const opt = document.createElement('option');
    opt.value = n;
    opt.textContent = n;
    nameSelect.appendChild(opt);
  });
}

function renderTable(header, data){
  const nameCol = header.find(h=>/nama|name/i.test(h)) || header[0];
  const filtered = data.filter(r => r[nameCol] === currentUser);

  theadRow.innerHTML = "";
  header.forEach(h=>{
    const th = document.createElement('th');
    th.textContent = h;
    theadRow.appendChild(th);
  });

  tbody.innerHTML = "";
  filtered.forEach(row=>{
    const tr = document.createElement('tr');
    header.forEach(h=>{
      const td = document.createElement('td');
      td.textContent = row[h];
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

// Login
loginBtn.addEventListener('click', ()=>{
  currentUser = nameSelect.value;
  if(currentUser){
    loginScreen.style.display = "none";
    absenScreen.style.display = "block";
    userNameSpan.textContent = currentUser;
    fetchCSV();
  }
});

// Logout
btnLogout.addEventListener('click', ()=>{
  currentUser = "";
  absenScreen.style.display = "none";
  loginScreen.style.display = "block";
});

// Reload data
btnReload.addEventListener('click', ()=> fetchCSV());

// Load awal
fetchCSV();
</script>

</body>
</html>
